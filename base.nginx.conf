# The maximum number of connections for Nginx is calculated by:
# max_clients = worker_processes * worker_connections
worker_processes 8;

# Maximum open file descriptors per process;
# should be > worker_connections.
worker_rlimit_nofile 8192;

events { worker_connections 8000; }

daemon off;

add_header X-Frame-Options SAMEORIGIN;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://ssl.google-analytics.com https://assets.zendesk.com https://connect.facebook.net; img-src 'self' https://ssl.google-analytics.com https://s-static.ak.facebook.com https://assets.zendesk.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://assets.zendesk.com; font-src 'self' https://themes.googleusercontent.com; frame-src https://assets.zendesk.com https://www.facebook.com https://s-static.ak.facebook.com https://tautt.zendesk.com; object-src 'none'";

error_log PROJECT_ROOT/nginx/logs/chars-error.log;

http {

  # Hide nginx version information
  server_tokens off;

  include mime.types;
  default_type application/octet-stream;

  access_log PROJECT_ROOT/nginx/logs/chars-access.log;

  # How long to allow each connection to stay idle; longer values are better
  # for each individual client, particularly for SSL, but means that worker
  # connections are tied up longer. (Default: 65)
  keepalive_timeout 20;

  # Speed up file transfers by using sendfile() to copy directly
  # between descriptors rather than using read()/write().
  sendfile on;

  # Tell Nginx not to send out partial frames; this increases throughput
  # since TCP frames are filled up before being sent out. (adds TCP_CORK)
  tcp_nopush on;

  # Compression
  gzip on;
  gzip_disable "msie6";
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_buffers 16 8k;
  gzip_proxied any;
  gzip_vary on;
  gzip_types
    application/javascript
    application/x-javascript
    application/json
    application/ld+json
    application/atom+xml
    application/manifest+json
    application/rss+xml
    application/vnd.geo+json
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-web-app-manifest+json
    application/xhtml+xml
    application/xml
    application/xml+rss
    font/opentype
    image/bmp
    image/svg+xml
    image/x-icon
    text/cache-manifest
    text/css
    text/plain
    text/js
    text/xml
    text/javascript
    text/vcard
    text/vnd.rim.location.xloc
    text/vtt
    text/x-component
    text/x-cross-domain-policy;

  # Ensure that redirects don't include the internal container PORT - 9090
  port_in_redirect off;

  server {
    listen 5000 default_server;
    server_name localhost;
    underscores_in_headers on;
    ssi on;

    # Ensure that only requests routed via ISAM are processed - COMMENT OUT FOR LOCAL DEVELOPMENT
    # set $authorized false;
    # if ( $http_authorization = "@myibm.required.authorization.header@" ) { set $authorized true; }
    # if ( $uri = /status ) { set $authorized true; }
    # if ( $authorized != true ) { return 403; }
    
    location /unicodedata {
        proxy_pass https://www.unicode.org/Public/UCD/latest/ucd/UnicodeData.txt;
        proxy_redirect off;
    }
    
    location / {
        root PROJECT_ROOT;
        index index.html;
    }
  }
}
